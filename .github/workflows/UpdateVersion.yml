name: UpdateVersion

on:
  workflow_dispatch:
    inputs:
      version_input:
        description: '输入格式为"版本名 版本号"，例如：1.2.0-Dev 2.7'
        required: true
        default: ''

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse version input
        id: parse-version
        run: |
          input="${{ github.event.inputs.version_input }}"
          version_name=$(echo "$input" | awk '{print $1}')
          version_number=$(echo "$input" | awk '{print $2}')
          current_timestamp=$(date +%Y%m%d%H%M)
          
          # 去掉版本号的小数点（2.7 → 27）
          version_number_int=$(echo "$version_number" | tr -d '.')
          version_number_int_with_timestamp="$version_number_int$current_timestamp"
          
          echo "Parsed version name: $version_name"
          echo "Parsed version number: $version_number"
          echo "Version number without dots: $version_number_int"
          echo "Version number with timestamp: $version_number_int_with_timestamp"
          
          echo "version_name=$version_name" >> $GITHUB_OUTPUT
          echo "version_number=$version_number" >> $GITHUB_OUTPUT
          echo "version_number_int_with_timestamp=$version_number_int_with_timestamp" >> $GITHUB_OUTPUT

      - name: Update gitVersion.txt
        run: |
          echo "Updating gitVersion.txt..."
          echo "${{ steps.parse-version.outputs.version_name }}" > gitVersion.txt
          echo "${{ steps.parse-version.outputs.version_number }}" >> gitVersion.txt
          echo "Updated gitVersion.txt content:"
          cat gitVersion.txt

      - name: Update Project.xml
        run: |
          echo "Updating Project.xml..."
          sed -i "s/\(<app title=\"NovaFlare Engine\".* version=\"\)[^\"]*\(\"\)/\1${{ steps.parse-version.outputs.version_name }}\2/" Project.xml
          if grep -q 'build-number="[^"]*"' Project.xml; then
            sed -i "s/\(<app title=\"NovaFlare Engine\".* build-number=\"\)[^\"]*\(\"\)/\1${{ steps.parse-version.outputs.version_number_int_with_timestamp }}\2/" Project.xml
            echo "Updated existing build-number attribute with integer version and timestamp"
          else
            sed -i "s/\(<app title=\"NovaFlare Engine\".* version=\"[^\"]*\"\)/\1 build-number=\"${{ steps.parse-version.outputs.version_number_int_with_timestamp }}\"/" Project.xml
            echo "Added build-number attribute with integer version and timestamp"
          fi
          echo "Updated Project.xml version and build-number attributes"

      - name: Update MainMenuState.hx
        run: |
          echo "Updating MainMenuState.hx..."
          sed -i "s/\(public static var novaFlareEngineVersion:String = '\)[^']*/\1${{ steps.parse-version.outputs.version_name }}/" source/states/MainMenuState.hx
          sed -i "s/\(public static var novaFlareEngineDataVersion:Float = \)[0-9.]*/\1${{ steps.parse-version.outputs.version_number }}/" source/states/MainMenuState.hx
          echo "Updated MainMenuState.hx version variables"

      - name: Commit all changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add gitVersion.txt Project.xml source/states/MainMenuState.hx
          git commit -m "chore: Update versions to ${{ steps.parse-version.outputs.version_name }} ${{ steps.parse-version.outputs.version_number_int_with_timestamp }}"
          git push
